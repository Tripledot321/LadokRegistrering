<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betygsregistrering</title>
</head>
<body>
    <label for="courseCodeDropdown">Kurskod:</label>
    <select id="courseCodeDropdown"></select>

    <label for="assignmentDropdown">Uppgift i Canvas:</label>
    <select id="assignmentDropdown" multiple></select>

    <label for="moduleDropdown">Modul i Ladok:</label>
    <select id="moduleDropdown"></select>

    <label for="examDate">Examinationsdatum:</label>
    <input type="date" id="examDate" />

    <button type="button" onclick="updateDate()">Uppdatera datum</button>

    <button type="button" onclick="sendToLadok()">Skicka in</button>

    <ul id="studentList"></ul>

<script>
    async function getCourseCodes() {
    try {
        const response = await fetch('http://localhost:3000/epok/get_AllCourseCodes');
        console.log('Response:', response);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Data:', data);

        const courses = data.courseCodes;

        const courseCodeDropdown = document.getElementById('courseCodeDropdown');
        courseCodeDropdown.innerHTML = '';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = ''; // Adjust to your needs
        defaultOption.text = '- Välj Kurs -';
        courseCodeDropdown.appendChild(defaultOption);

        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.text = course;
            courseCodeDropdown.appendChild(option);
        });
        // Add event listener for course selection
        courseCodeDropdown.addEventListener('change', () => {
        const selectedCourseCode = courseCodeDropdown.value;
        getModulesForCourse(selectedCourseCode);
        getAssignmentsForCourse(selectedCourseCode);
        getStudentsForCourse(selectedCourseCode);
        });

        // Initial call to getModulesForCourse with the default course code (empty string)
        getModulesForCourse('');
        getAssignmentsForCourse('');
        getStudentsForCourse('');
    } catch (error) {
        console.error('Error:', error);
    }
}

async function getModulesForCourse(courseCode) {
    try {
        // Fetch modules based on the selected courseCode
        const response = await fetch(`http://localhost:3000/epok/get_Module?courseCode=${courseCode}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // Parse the response
        const data = await response.json();
        console.log('Modules:', data.activeModules);

        // Populate the module dropdown
        const moduleDropdown = document.getElementById('moduleDropdown');
        moduleDropdown.innerHTML = '';

        // Add default option
        const defaultModuleOption = document.createElement('option');
        defaultModuleOption.value = ''; // Adjust to your needs
        defaultModuleOption.text = '- Välj Modul -';
        moduleDropdown.appendChild(defaultModuleOption);

        // Check if activeModules is defined before using it
        if (data.activeModules) {
            // Populate the dropdown with module data
            data.activeModules.forEach(module => {
                const moduleOption = document.createElement('option');
                moduleOption.value = module.Code; // Adjust to access the appropriate property
                moduleOption.text = module.Description; // Adjust to access the appropriate property
                moduleDropdown.appendChild(moduleOption);
            });
        } else {
            console.error('No module data found.');
        }

    } catch (error) {
        console.error('Error fetching modules for the course:', error);
    }
}

async function getAssignmentsForCourse(courseCode) {
    try {
        // Fetch modules based on the selected courseCode
        const response = await fetch(`http://localhost:3000/canvas/get_Assignments?courseCode=${courseCode}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // Parse the response
        const data = await response.json();

        // Populate the module dropdown
        const assignmentDropdown = document.getElementById('assignmentDropdown');
        assignmentDropdown.innerHTML = '';

        // Add default option
        const defaultAssignmentOption = document.createElement('option');
        defaultAssignmentOption.value = ''; // Adjust to your needs
        defaultAssignmentOption.text = '- Välj Assignments -';
        assignmentDropdown.appendChild(defaultAssignmentOption);

        // Check if activeModules is defined before using it
        if (data.assignments) {
            data.assignments.forEach(assignment => {
            const assignmentOption = document.createElement('option');
            assignmentOption.value = assignment.assignmentId;
            assignmentOption.text = assignment.assignment;
            assignmentDropdown.appendChild(assignmentOption);
            });
        assignmentDropdown.multiple = true;
        } else {
            console.error('No assignments found.');
        }
    } catch (error) {
        console.error('Error fetching assignments for the course:', error);
    }
};
// Assignment
async function getStudentsForCourse(courseCode) {
    try {
        // Fetch students based on the selected courseCode
        const response = await fetch(`http://localhost:3000/canvas/get_StudentList?courseCode=${courseCode}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // Parse the response
        const data = await response.json();

        // Populate the module dropdown
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = '';

        if (data) {
    const studentList = document.getElementById('studentList');

    data.forEach(student => {
        // Create a checkbox for each student
        const selectCheckbox = document.createElement('input');
        selectCheckbox.type = 'checkbox';
        selectCheckbox.id = `selectCheckbox_${student.studentId}`;

        // Create a label for the checkbox
        const checkboxLabel = document.createElement('label');
        checkboxLabel.textContent = 'Select';
        checkboxLabel.htmlFor = selectCheckbox.id;

        // Create a list item for each student
        const studentOption = document.createElement('li');

        // Add student details to the list item
        const gradesHTML = student.grades.map(grade => `
            <span>Assignment: ${grade.assignmentId}</span>
            <span>Grade: ${grade.grade}</span>
        `).join('<br>');

        studentOption.innerHTML = `
            <span>${student.studentId}</span>
            <div>${gradesHTML}</div>
        `;

        // Append the checkbox, label, and list item to the student list
        studentList.appendChild(selectCheckbox);
        studentList.appendChild(checkboxLabel);
        studentList.appendChild(studentOption);
    });
} else {
    console.error('No students found.');
}

    } catch (error) {
        console.error('Error fetching students for the course:', error);
    }
};

getCourseCodes();
</script>
</body>
</html>